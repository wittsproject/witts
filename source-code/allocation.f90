! This module declares the sizes of dynamic global arrays.
! Also, it will deallocate those arrays at the end of simulation.
  MODULE ALLOCATION

  USE parameters
  USE field_shared

  IMPLICIT NONE

  CONTAINS
!-----------------------------------------------------------------!
!                  ALLOCATE GLOBAL ARRAYS                         !
!-----------------------------------------------------------------!
    SUBROUTINE ALLOCATE_GLOBAL()
      
    ALLOCATE(X(NXT+1),Y(NYT+1),Z(NZT+1))
    ALLOCATE(XI(NXT+1),YI(NYT+1),ZI(NZT+1))
    ALLOCATE(RHO(NX1:NX2,NY1:NY2,NZ1:NZ2),MU(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(U (NX1:NX2,NY1:NY2,NZ1:NZ2),V (NX1:NX2,NY1:NY2,NZ1:NZ2), &
             W (NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(PHI(NX1:NX2,NY1:NY2,NZ1:NZ2),PD(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(NU(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(UF(NX1:NX2,NY1:NY2,NZ1:NZ2),VF(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             WF(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(FX(NX1:NX2,NY1:NY2,NZ1:NZ2),FY(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             FZ(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(TE(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(UA(NX1:NX2,NY1:NY2,NZ1:NZ2),VA(NX1:NX2,NY1:NY2,NZ1:NZ2),  &
             WA(NX1:NX2,NY1:NY2,NZ1:NZ2),                              &
             TEA(NX1:NX2,NY1:NY2,NZ1:NZ2),PDA(NX1:NX2,NY1:NY2,NZ1:NZ2),&
             RHOA(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(TAU11(NX1:NX2,NY1:NY2,NZ1:NZ2),TAU22(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             TAU33(NX1:NX2,NY1:NY2,NZ1:NZ2),TAU12(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             TAU13(NX1:NX2,NY1:NY2,NZ1:NZ2),TAU23(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(TAU12W_1(NY1:NY2,NZ1:NZ2),TAU13W_1(NY1:NY2,NZ1:NZ2),Q1W_1(NY1:NY2,NZ1:NZ2))
    ALLOCATE(TAU12W_2(NY1:NY2,NZ1:NZ2),TAU13W_2(NY1:NY2,NZ1:NZ2),Q1W_2(NY1:NY2,NZ1:NZ2))
    ALLOCATE(TAU12W_3(NX1:NX2,NZ1:NZ2),TAU23W_3(NX1:NX2,NZ1:NZ2),Q2W_3(NX1:NX2,NZ1:NZ2))
    ALLOCATE(TAU12W_4(NX1:NX2,NZ1:NZ2),TAU23W_4(NX1:NX2,NZ1:NZ2),Q2W_4(NX1:NX2,NZ1:NZ2))
    ALLOCATE(TAU13W_5(NX1:NX2,NY1:NY2),TAU23W_5(NX1:NX2,NY1:NY2),Q3W_5(NX1:NX2,NY1:NY2))
    ALLOCATE(TAU13W_6(NX1:NX2,NY1:NY2),TAU23W_6(NX1:NX2,NY1:NY2),Q3W_6(NX1:NX2,NY1:NY2))
    ALLOCATE(UUA(NX1:NX2,NY1:NY2,NZ1:NZ2),VVA(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             WWA(NX1:NX2,NY1:NY2,NZ1:NZ2),                              &
             UVA(NX1:NX2,NY1:NY2,NZ1:NZ2),UWA(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             VWA(NX1:NX2,NY1:NY2,NZ1:NZ2))
    ALLOCATE(UTA(NX1:NX2,NY1:NY2,NZ1:NZ2),VTA(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             WTA(NX1:NX2,NY1:NY2,NZ1:NZ2),                              &
             UPA(NX1:NX2,NY1:NY2,NZ1:NZ2),VPA(NX1:NX2,NY1:NY2,NZ1:NZ2), &
             WPA(NX1:NX2,NY1:NY2,NZ1:NZ2))

    X=0.0
    Y=0.0
    Z=0.0
    XI=0.0
    YI=0.0
    ZI=0.0

    RHO=0.0
    MU=0.0
    NU=0.0
    U=0.0
    V=0.0
    W=0.0
    PHI=0.0
    PD=0.0
    UF=0.0
    VF=0.0
    WF=0.0
    FX=0.0
    FY=0.0
    FZ=0.0
    TE=0.0
    
    UA=0.0
    VA=0.0
    WA=0.0
    TEA=0.0
    PDA=0.0
    RHOA=0.0

    TAU11=0.0
    TAU22=0.0
    TAU33=0.0
    TAU12=0.0
    TAU13=0.0
    TAU23=0.0

    TAU12W_1=0.0
    TAU13W_1=0.0
    Q1W_1=0.0
    TAU12W_2=0.0
    TAU13W_2=0.0
    Q1W_2=0.0
    TAU12W_3=0.0
    TAU23W_3=0.0
    Q2W_3=0.0
    TAU12W_4=0.0
    TAU23W_4=0.0
    Q2W_4=0.0
    TAU13W_5=0.0
    TAU23W_5=0.0
    Q3W_5=0.0
    TAU13W_6=0.0
    TAU23W_6=0.0
    Q3W_6=0.0

    UUA=0.0
    VVA=0.0
    WWA=0.0
    UVA=0.0
    UWA=0.0
    VWA=0.0
    UTA=0.0
    VTA=0.0
    WTA=0.0
    UPA=0.0
    VPA=0.0
    WPA=0.0

    IF(ITYPE.EQ.1)THEN
      ALLOCATE(CS2(NX1:NX2,NY1:NY2,NZ1:NZ2),BETA(NX1:NX2,NY1:NY2,NZ1:NZ2),   &
               DISSIP(NX1:NX2,NY1:NY2,NZ1:NZ2),                              &
               PLM(NX1:NX2,NY1:NY2,NZ1:NZ2),PMM(NX1:NX2,NY1:NY2,NZ1:NZ2),    &
               PQN(NX1:NX2,NY1:NY2,NZ1:NZ2),PNN(NX1:NX2,NY1:NY2,NZ1:NZ2))
      CS2=0.0
      BETA=0.0
      DISSIP=0.0
      PLM=0.0  
      PMM=0.0
      PQN=0.0
      PNN=0.0
    END IF

    END SUBROUTINE

!-----------------------------------------------------------------!
!                  DEALLOCATE GLOBAL ARRAYS                       !
!-----------------------------------------------------------------!
    SUBROUTINE DEALLOCATE_GLOBAL()

    DEALLOCATE(X,Y,Z,XI,YI,ZI,RHO,MU,PHI,PD,NU)
    DEALLOCATE(U,V,W,UF,VF,WF,TE,FX,FY,FZ)
    DEALLOCATE(UA,VA,WA,TEA,PDA,RHOA)
    DEALLOCATE(UUA,VVA,WWA,UVA,UWA,VWA, &
               UTA,VTA,WTA,UPA,WPA,VPA)
    DEALLOCATE(TAU12W_1,TAU13W_1,Q1W_1,TAU12W_2,TAU13W_2,Q1W_2,&
               TAU12W_3,TAU23W_3,Q2W_3,TAU12W_4,TAU23W_4,Q2W_4,&
               TAU13W_5,TAU23W_5,Q3W_5,TAU13W_6,TAU23W_6,Q3W_6)
    IF(ITYPE.EQ.1)THEN
      DEALLOCATE(CS2,BETA,DISSIP,PLM,PMM,PQN,PNN)
    END IF

    END SUBROUTINE

  END MODULE
